<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>二维码</title>
     <link rel="icon" href="../../images/icon.ico">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../css/normalize.css">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../layui-v2.2.6/layui/css/layui.css">
</head>
<body>
    <div class="wrap">
        <div class="layui-layout loginBg">
            <div class="loginErweima">
                <div class="erweima" id="code"></div>
                <p class="loginNotice">
                    <span>二维三分钟之内有效</span>
                    <a href="#" class="reload">刷新二维码</a>
                </p>
            </div>
        </div>
    </div>
    <!-- //wrap -->
    <script type="text/javascript" src="../../js/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="../../layui-v2.2.6/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../js/jquery.qrcode.min.js"></script>
    <script>
        $(function(){
            var uuid = getQueryString('uuid');
            var back = 'http://wx.rrzhaofang.com/authorization.html?uuid='+uuid+"&type=1";
            back = encodeURI(back);
            var str = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxbe1cdb19d2290193&redirect_uri="+back+"&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect";
            $('#code').qrcode(str);
        })

        var uuid = getQueryString('uuid');
        var num = 0;
        var i = setInterval(function()
        {
            num++;
            $.post('http://api.rrzhaofang.com/admin/wechat/testing',{uuid:uuid},function ( res ) {
                if( res )
                {
                    if( res.status == 1 )
                    {
                        window.location.href='wpwd.html?uuid='+uuid+'&openid='+res.data.wechatopenid;
                    }
                }
            },'json');
            if ( num > 90 )
            {
                $('#code').html('');
                clearInterval(i);
            }
        }, 3000);

        function getQueryString( name )
        {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); // 匹配目标参数
            var result = window.location.search.substr(1).match(reg); // 对querystring匹配目标参数
            if (result != null)
            {
                return decodeURIComponent(result[2]);
            }else
            {
                return null;
            }
        }
    </script>
</body>
</html>